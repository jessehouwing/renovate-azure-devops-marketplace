{
    "id": "665e300e-f163-48a6-aa33-589213df991c",
    "name": "releaseNotes",
    "friendlyName": "Bravo Notes - Compile release notes",
    "description": "Bravo Notes - Compile release notes. Generate release notes as Markdown, HTML or PDF documents.",
    "author": "Agile Extensions",
    "category": "Utility",
    "visibility": ["Build", "Release"],
    "version": {
        "Major": 2,
        "Minor": 71,
        "Patch": 0
    },
    "minimumAgentVersion": "1.82.0",
    "instanceNameFormat": "Release Notes",
    "groups": [
        {
            "name": "advanced",
            "displayName": "Advanced",
            "isExpanded": false
        }
    ],
    "inputs": [
        {
            "name": "notes",
            "type": "pickList",
            "label": "Bravo Notes template",
            "defaultValue": "",
            "required": true,
            "properties": {
                "EditableOptions": "True"
            },
            "helpMarkDown": "Choose a template previously created via the Bravo Notes UI."
        },
        {
            "name": "workItemSource",
            "type": "pickList",
            "label": "Work item source",
            "defaultValue": "Associated",
            "required": true,
            "options": {
                "Associated": "Associated Work Items",
                "Query": "Query",
                "JsonFile": "JSON file"
            },
            "helpMarkDown": "Specify what work items should be pulled into the template. Associated Work Items = Work Items associated with the current build or the current release. The latter only pulls in Work Items associated since the last successful deployment of the current environment. When using JSON file as source the expected format is a array of objects with an \"id\" property e.g. [{\"id\": 345}, {\"id\": 654}]"
        },
        {
            "name": "workItemTypeResolving",
            "type": "pickList",
            "label": "Work Items to resolve",
            "defaultValue": "Associated",
            "required": true,
            "options": {
                "Associated": "All directly associated Work Items",
                "ParentWorkItems": "Selected types (directly associated or parents)"
            },
            "helpMarkDown": "Chose to load work items directly associated to the build / release or to load parent work items of the specified type.",
            "visibleRule": "workItemSource = Associated || workItemSource = JsonFile"
        },
        {
            "name": "workItemTypesToLoad",
            "type": "multiLine",
            "label": "Work Item types",
            "required": true,
            "helpMarkDown": "Specify one work item type name per line",
            "visibleRule": "workItemTypeResolving = ParentWorkItems"
        },
        {
            "name": "queryId",
            "type": "querycontrol",
            "label": "Query",
            "defaultValue": "",
            "required": "true",
            "helpMarkDown": "Select a saved Work Item query to execute.",
            "visibleRule": "workItemSource = Query"
        },
        {
            "name": "inputFilePath",
            "type": "filePath",
            "label": "Input file path",
            "defaultValue": "",
            "required": true,
            "visibleRule": "workItemSource = JsonFile",
            "helpMarkDown": "Path to read from item data from"
        },
        {
            "name": "outputFormat",
            "type": "pickList",
            "label": "Output format",
            "defaultValue": "md",
            "required": true,
            "options": {
                "md": "Markdown",
                "html": "HTML",
                "pdf": "PDF"
            },
            "helpMarkDown": "Format of the rendered document"
        },
        {
            "name": "handleImages",
            "type": "pickList",
            "label": "Handle images",
            "defaultValue": "none",
            "required": true,
            "options": {
                "none": "Keep as is",
                "local": "Download to images folder",
                "public": "Publish and host on bravonotes.com"
            },
            "helpMarkDown": "If images are included in the generated document, this option controls how to handle them. Image URLs will be adjusted accordingly.",
            "visibleRule": "outputFormat = html || outputFormat = md"
        },
        {
            "name": "outputTarget",
            "type": "pickList",
            "label": "Output target",
            "defaultValue": "File",
            "required": true,
            "options": {
                "file": "File",
                "wiki": "Wiki"
            },
            "helpMarkDown": "Target to store the rendered document"
        },
        {
            "name": "outputFilePath",
            "type": "filePath",
            "label": "Output file path",
            "defaultValue": "",
            "required": true,
            "visibleRule": "outputTarget = File",
            "helpMarkDown": "Path to write rendered notes to e.g. releasenotes.pdf"
        },
        {
            "name": "targetRepo",
            "type": "pickList",
            "label": "Target repository",
            "defaultValue": "",
            "required": true,
            "visibleRule": "outputTarget = Repository",
            "helpMarkDown": "Git repository to store the generated file"
        },
        {
            "name": "targetBranch",
            "type": "string",
            "label": "Target branch",
            "defaultValue": "master",
            "required": true,
            "visibleRule": "outputTarget = Repository",
            "helpMarkDown": "Branch in to commit the generated file to"
        },
        {
            "name": "targetRepoPath",
            "type": "string",
            "label": "File path",
            "defaultValue": "",
            "required": true,
            "visibleRule": "outputTarget = Repository",
            "helpMarkDown": "Path in selected repository to save generated file to"
        },
        {
            "name": "targetWiki",
            "type": "pickList",
            "label": "Target Wiki",
            "defaultValue": "",
            "required": true,
            "visibleRule": "outputTarget = Wiki",
            "helpMarkDown": "Wiki to store the generated markdown file"
        },
        {
            "name": "targetWikiPath",
            "type": "string",
            "label": "Wiki page path",
            "defaultValue": "",
            "required": true,
            "visibleRule": "outputTarget = Wiki",
            "helpMarkDown": "Path to Wiki page to write rendered notes to"
        },
        {
            "name": "extensionId",
            "type": "string",
            "label": "Extension ID",
            "defaultValue": "bravo-notes",
            "required": true,
            "visibleRule": "workItemSource = NEVER",
            "helpMarkDown": "This is just a workarround to pass the extensionId to the task"
        },
        {
            "name": "extensionVersion",
            "type": "string",
            "label": "Extension Version",
            "defaultValue": "3.0.1632",
            "required": true,
            "visibleRule": "workItemSource = NEVER",
            "helpMarkDown": "This is just a workarround to pass the extension version to the task"
        },
        {
            "name": "stopLabel",
            "type": "string",
            "label": "Stop label key",
            "defaultValue": "",
            "required": false,
            "helpMarkDown": "When looking up the work item hierarchy from associated work items, when a work item with the specified stop label is found parents of that item will not be imported.",
            "groupName": "advanced"
        }
    ],

    "dataSourceBindings": [
        {
            "target": "notes",
            "endpointId": "tfs:ems",
            "endpointUrl": "{{endpoint.url}}/_apis/ExtensionManagement/InstalledExtensions/agile-extensions/bravo-notes/Data/Scopes/Default/Current/Collections/rn-index/Documents",
            "resultSelector": "jsonpath:$.value[*]",
            "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{title}}}\" }"
        },
        {
            "target": "targetWiki",
            "endpointId": "tfs:teamfoundation",
            "endpointUrl": "{{endpoint.url}}/{{system.teamProject}}/_apis/wiki/wikis?api-version=4.1-preview",
            "resultSelector": "jsonpath:$.value[*]",
            "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{name}}}\" }"
        },
        {
            "target": "targetRepo",
            "endpointId": "tfs:teamfoundation",
            "endpointUrl": "{{endpoint.url}}/{{system.teamProject}}/_apis/git/Repositories",
            "resultSelector": "jsonpath:$.value[*]",
            "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{name}}}\" }"
        }
    ],

    "execution": {
        "Node": {
            "target": "run.js",
            "argumentFormat": ""
        }
    }
}
